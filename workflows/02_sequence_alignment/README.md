# 02_åºåˆ—æ¯”å¯¹ (Sequence Alignment)

## ğŸ“‹ ç›®å½•è¯´æ˜

æœ¬ç›®å½•åŒ…å«åŸºå› ç»„åºåˆ—æ¯”å¯¹ç›¸å…³çš„å·¥ä½œæµå’Œå·¥å…·ï¼Œè´Ÿè´£å°†é¢„å¤„ç†åçš„æµ‹åºreadsæ¯”å¯¹åˆ°å‚è€ƒåŸºå› ç»„ä¸Šã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### åºåˆ—æ¯”å¯¹ (Read Alignment)
- **BWA-MEM**: é«˜æ•ˆçš„çŸ­åºåˆ—æ¯”å¯¹ç®—æ³•
- **Bowtie2**: æ›¿ä»£æ¯”å¯¹å·¥å…·
- **STAR**: RNA-seqæ•°æ®æ¯”å¯¹ï¼ˆå¦‚éœ€è¦ï¼‰
- å¤šæ–‡ä»¶å¹¶è¡Œæ¯”å¯¹å¤„ç†

### æ¯”å¯¹åå¤„ç† (Post-alignment Processing)
- **SAM/BAMæ ¼å¼è½¬æ¢**: æ ‡å‡†åŒ–æ¯”å¯¹ç»“æœæ ¼å¼
- **æ’åºå’Œç´¢å¼•**: æé«˜åç»­åˆ†ææ•ˆç‡
- **æ¯”å¯¹è´¨é‡è¯„ä¼°**: æ¯”å¯¹ç‡å’Œè¦†ç›–åº¦ç»Ÿè®¡
- **é‡å¤æ ‡è®°**: æ ‡è®°PCRå’Œå…‰å­¦é‡å¤

### è´¨é‡æ§åˆ¶ (Quality Assessment)
- æ¯”å¯¹ç‡ç»Ÿè®¡
- æ’å…¥ç‰‡æ®µå¤§å°åˆ†å¸ƒ
- è¦†ç›–æ·±åº¦åˆ†æ
- æ¯”å¯¹è´¨é‡åˆ†æ•°åˆ†å¸ƒ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
02_sequence_alignment/
â”œâ”€â”€ README.md                           # æœ¬è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ multi_file_alignment_workflow.wdl  # å¤šæ–‡ä»¶æ¯”å¯¹ä¸»å·¥ä½œæµ
â”œâ”€â”€ tasks/                              # ä»»åŠ¡å®šä¹‰ç›®å½•ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ bwa_alignment_task.wdl         # BWAæ¯”å¯¹ä»»åŠ¡
â”‚   â”œâ”€â”€ sam_processing_task.wdl        # SAM/BAMå¤„ç†ä»»åŠ¡
â”‚   â”œâ”€â”€ alignment_qc_task.wdl          # æ¯”å¯¹è´¨é‡æ§åˆ¶ä»»åŠ¡
â”‚   â””â”€â”€ duplicate_marking_task.wdl     # é‡å¤æ ‡è®°ä»»åŠ¡
â”œâ”€â”€ inputs/                             # è¾“å…¥å‚æ•°é…ç½®ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â””â”€â”€ alignment_inputs.json          # æ¯”å¯¹å‚æ•°é…ç½®æ–‡ä»¶
â””â”€â”€ scripts/                            # è¾…åŠ©è„šæœ¬ï¼ˆå¾…åˆ›å»ºï¼‰
    â”œâ”€â”€ prepare_reference.sh           # å‚è€ƒåŸºå› ç»„ç´¢å¼•å‡†å¤‡
    â””â”€â”€ alignment_stats.py             # æ¯”å¯¹ç»Ÿè®¡åˆ†æ
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å‚è€ƒåŸºå› ç»„å‡†å¤‡
```bash
# åˆ›å»ºBWAç´¢å¼•
bwa index reference_genome.fasta

# åˆ›å»ºsamtoolsç´¢å¼•
samtools faidx reference_genome.fasta

# åˆ›å»ºåºåˆ—å­—å…¸
picard CreateSequenceDictionary \
    R=reference_genome.fasta \
    O=reference_genome.dict
```

### 2. å¤šæ–‡ä»¶æ¯”å¯¹æµç¨‹
```bash
# ä½¿ç”¨AWS Omicsè¿è¡Œå¤šæ–‡ä»¶æ¯”å¯¹å·¥ä½œæµ
aws omics start-run \
    --workflow-id <workflow-id> \
    --parameters file://inputs/alignment_inputs.json \
    --name "cattle-alignment-$(date +%Y%m%d)"
```

### 3. è¾“å…¥æ•°æ®è¦æ±‚
- **é¢„å¤„ç†åçš„FASTQæ–‡ä»¶**: æ¥è‡ª01_data_preprocessingæ­¥éª¤
- **å‚è€ƒåŸºå› ç»„**: å¥¶ç‰›ARS-UCD1.2åŸºå› ç»„
- **è¯»ç»„ä¿¡æ¯**: æ ·æœ¬IDã€æ–‡åº“ä¿¡æ¯ã€æµ‹åºå¹³å°

## âš™ï¸ æ¯”å¯¹å‚æ•°é…ç½®

### BWA-MEMå‚æ•°
- **æœ€å°ç§å­é•¿åº¦**: 19
- **å¸¦å®½**: 100
- **Z-dropoff**: 100
- **3'ç«¯å‰ªåˆ‡æƒ©ç½š**: 5

### SAM/BAMå¤„ç†
- **æ’åºæ–¹å¼**: æŒ‰åæ ‡æ’åº
- **å‹ç¼©çº§åˆ«**: 6 (å¹³è¡¡é€Ÿåº¦å’Œå­˜å‚¨)
- **ç´¢å¼•åˆ›å»º**: è‡ªåŠ¨ç”ŸæˆBAIç´¢å¼•

### è´¨é‡è¿‡æ»¤
- **æœ€å°æ¯”å¯¹è´¨é‡**: MAPQ â‰¥ 20
- **å»é™¤æœªæ¯”å¯¹reads**: æ˜¯
- **å»é™¤æ¬¡è¦æ¯”å¯¹**: æ˜¯

## ğŸ“Š è¾“å‡ºç»“æœ

### ä¸»è¦è¾“å‡ºæ–‡ä»¶
- **sorted.bam**: æ’åºåçš„æ¯”å¯¹ç»“æœ
- **sorted.bam.bai**: BAMæ–‡ä»¶ç´¢å¼•
- **alignment_stats.txt**: æ¯”å¯¹ç»Ÿè®¡ä¿¡æ¯
- **coverage_report.html**: è¦†ç›–åº¦åˆ†ææŠ¥å‘Š

### è´¨é‡æŒ‡æ ‡
- **æ€»æ¯”å¯¹ç‡**: >95% (é«˜è´¨é‡æ•°æ®)
- **å”¯ä¸€æ¯”å¯¹ç‡**: >90%
- **å¹³å‡è¦†ç›–æ·±åº¦**: 30X (æ¨è)
- **è¦†ç›–å‡åŒ€æ€§**: CV < 0.3

## ğŸ”§ å·¥ä½œæµç‰¹æ€§

### å¤šæ–‡ä»¶æ”¯æŒ
- åŒæ—¶å¤„ç†å¤šä¸ªFASTQæ–‡ä»¶å¯¹
- è‡ªåŠ¨åˆå¹¶åŒä¸€æ ·æœ¬çš„å¤šä¸ªæ–‡åº“
- ä¿æŒè¯»ç»„ä¿¡æ¯å®Œæ•´æ€§

### å¹¶è¡Œå¤„ç†
- æŸ“è‰²ä½“çº§åˆ«å¹¶è¡Œæ¯”å¯¹
- å¤šçº¿ç¨‹BWAæ¯”å¯¹
- åˆ†å¸ƒå¼è®¡ç®—ä¼˜åŒ–

### é”™è¯¯å¤„ç†
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- ä¸­é—´æ–‡ä»¶æ¸…ç†
- è¯¦ç»†æ—¥å¿—è®°å½•

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### è®¡ç®—èµ„æº
- **CPU**: 16-32æ ¸å¿ƒæ¨è
- **å†…å­˜**: 64GBæ¨è
- **å­˜å‚¨**: é«˜IOPS SSDå­˜å‚¨

### ä¼˜åŒ–ç­–ç•¥
- å‚è€ƒåŸºå› ç»„é¢„åŠ è½½
- æµå¼å¤„ç†å‡å°‘I/O
- æ™ºèƒ½ä»»åŠ¡è°ƒåº¦

## ğŸ”— æ•°æ®æµå‘

### è¾“å…¥æ¥æº
- **01_data_preprocessing**: æ¸…ç†åçš„FASTQæ–‡ä»¶
- **genomic_data/02_reference_genome**: å‚è€ƒåŸºå› ç»„æ–‡ä»¶

### è¾“å‡ºå»å‘
- **03_variant_detection**: BAMæ–‡ä»¶ç”¨äºå˜å¼‚æ£€æµ‹
- **genomic_data/03_alignment_results**: å­˜å‚¨æ¯”å¯¹ç»“æœ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BWAç”¨æˆ·æ‰‹å†Œ](http://bio-bwa.sourceforge.net/bwa.shtml)
- [SAMtoolsæ–‡æ¡£](http://www.htslib.org/doc/samtools.html)
- [AWS Omicsæœ€ä½³å®è·µ](https://docs.aws.amazon.com/omics/latest/dev/workflows-best-practices.html)

---

**æ³¨æ„**: åºåˆ—æ¯”å¯¹æ˜¯è®¡ç®—å¯†é›†å‹æ­¥éª¤ï¼Œåˆç†çš„å‚æ•°é…ç½®å’Œèµ„æºåˆ†é…å¯¹æ€§èƒ½è‡³å…³é‡è¦ã€‚
