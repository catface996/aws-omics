# AWS Omics å˜å¼‚æ£€æµ‹å·¥ä½œæµ

æœ¬ç›®å½•åŒ…å«ç”¨äºAWS HealthOmicsçš„å˜å¼‚æ£€æµ‹å·¥ä½œæµï¼Œæ”¯æŒä»BAMæ–‡ä»¶è¿›è¡Œé«˜è´¨é‡çš„å˜å¼‚æ£€æµ‹å’Œåˆ†æã€‚

## ğŸ¯ å·¥ä½œæµæ¦‚è¿°

### ä¸»è¦åŠŸèƒ½
- **GATK HaplotypeCaller**: é«˜ç²¾åº¦å˜å¼‚æ£€æµ‹
- **BCFtools**: å˜å¼‚è¿‡æ»¤å’Œç»Ÿè®¡åˆ†æ
- **å¤šæ ¼å¼è¾“å‡º**: VCFæ–‡ä»¶ã€ç»Ÿè®¡æŠ¥å‘Šã€åˆ†æå›¾è¡¨

### å·¥ä½œæµæ¶æ„
```
BAMæ–‡ä»¶ â†’ [GATKå˜å¼‚æ£€æµ‹] â†’ [BCFtoolsè¿‡æ»¤] â†’ æœ€ç»ˆå˜å¼‚ç»“æœ
   â†“              â†“              â†“              â†“
è¾“å…¥æ•°æ®        åŸå§‹VCF        è¿‡æ»¤VCF        ç»Ÿè®¡æŠ¥å‘Š
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

### ğŸ”§ **ç”Ÿäº§å°±ç»ªç‰ˆæœ¬**
- **`variant_calling_from_bam_final_fixed.wdl`** â­ **æ¨èä½¿ç”¨**
  - å®Œå…¨ä¿®å¤æ‰€æœ‰å·²çŸ¥é—®é¢˜
  - è§£å†³äº†GATKå‚æ•°å…¼å®¹æ€§é—®é¢˜
  - ä¿®å¤äº†åºåˆ—å­—å…¸è·¯å¾„é—®é¢˜
  - æ”¯æŒx86_64æ¶æ„Dockeré•œåƒ
  - ç»è¿‡å®Œæ•´æµ‹è¯•éªŒè¯

### ğŸ§ª **å¼€å‘å’Œæµ‹è¯•ç‰ˆæœ¬**
- **`variant_calling_from_bam_fixed.wdl`** - ç¬¬ä¸€ç‰ˆä¿®å¤
- **`variant_calling_from_bam_amd64.wdl`** - æ¶æ„å…¼å®¹æ€§ä¿®å¤
- **`variant_calling_from_bam_ecr.wdl`** - ECRé•œåƒç‰ˆæœ¬
- **`variant_calling_from_bam.wdl`** - åŸå§‹ç‰ˆæœ¬

### ğŸ“š **å†å²ç‰ˆæœ¬**
- **`variant_calling_workflow.wdl`** - æ—©æœŸç‰ˆæœ¬

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡è¾“å…¥æ•°æ®
```bash
# ç¡®ä¿æ‚¨æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š
# - å‚è€ƒåŸºå› ç»„ (FASTAæ ¼å¼)
# - æ’åºçš„BAMæ–‡ä»¶
# - BAMç´¢å¼•æ–‡ä»¶ (.bai)
```

### 2. éƒ¨ç½²å·¥ä½œæµ
```bash
# ä½¿ç”¨AWS CLIéƒ¨ç½²å·¥ä½œæµ
aws omics create-workflow \
    --name "variant-calling-production" \
    --definition-zip fileb://variant_calling_from_bam_final_fixed.wdl \
    --parameter-template file://parameter_template.json
```

### 3. å¯åŠ¨è¿è¡Œ
```bash
# å¯åŠ¨å˜å¼‚æ£€æµ‹è¿è¡Œ
aws omics start-run \
    --workflow-id <workflow-id> \
    --role-arn <omics-service-role-arn> \
    --name "variant-calling-$(date +%Y%m%d-%H%M%S)" \
    --output-uri "s3://your-bucket/omics-outputs/variant-calling/" \
    --parameters '{
        "reference_genome": "s3://your-bucket/reference.fna",
        "input_bam": "s3://your-bucket/sample.sorted.bam",
        "input_bam_index": "s3://your-bucket/sample.sorted.bam.bai",
        "sample_name": "your-sample-name",
        "gatk_cpu": 16,
        "gatk_memory_gb": 32,
        "bcftools_cpu": 8,
        "bcftools_memory_gb": 16
    }'
```

## ğŸ”§ å…³é”®ä¿®å¤è¯´æ˜

### âœ… **å·²è§£å†³çš„é—®é¢˜**

#### 1. **GATKå‚æ•°å…¼å®¹æ€§é—®é¢˜**
- **é—®é¢˜**: `--standard-min-confidence-threshold-for-emitting` åœ¨GATK 4.4.0.0ä¸­ä¸æ”¯æŒ
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨æ­£ç¡®çš„å‚æ•° `--standard-min-confidence-threshold-for-calling 20.0`

#### 2. **Dockeræ¶æ„å…¼å®¹æ€§é—®é¢˜**
- **é—®é¢˜**: ARM64é•œåƒåœ¨AWS Omics x86_64ç¯å¢ƒä¸­å¯¼è‡´"exec format error"
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨x86_64å…¼å®¹çš„Dockeré•œåƒ `omics/variant-calling:amd64`

#### 3. **åºåˆ—å­—å…¸è·¯å¾„é—®é¢˜**
- **é—®é¢˜**: GATKæœŸæœ›åºåˆ—å­—å…¸æ–‡ä»¶ä¸å‚è€ƒåŸºå› ç»„åœ¨åŒä¸€è·¯å¾„
- **è§£å†³æ–¹æ¡ˆ**: 
  ```bash
  # å¤åˆ¶å‚è€ƒåŸºå› ç»„åˆ°å·¥ä½œç›®å½•
  cp ~{reference} ./reference.fna
  # åœ¨åŒä¸€ç›®å½•åˆ›å»ºå­—å…¸æ–‡ä»¶
  gatk CreateSequenceDictionary -R ./reference.fna -O ./reference.dict
  ```

### ğŸ§ª **æµ‹è¯•éªŒè¯**
- **æµ‹è¯•æ•°æ®**: SRR16760538 (å¥¶ç‰›åŸºå› ç»„æµ‹åºæ•°æ®)
- **æµ‹è¯•ç»“æœ**: å·¥ä½œæµæˆåŠŸè¿è¡Œï¼Œä»»åŠ¡ç¨³å®šæ‰§è¡Œ
- **è¿è¡Œæ—¶é—´**: GATKä»»åŠ¡çº¦1-2å°æ—¶ï¼Œæ€»ä½“çº¦2-3å°æ—¶

## ğŸ“Š è¾“å‡ºæ–‡ä»¶

### ä¸»è¦è¾“å‡º
- **`raw_variants_vcf`**: åŸå§‹å˜å¼‚VCFæ–‡ä»¶ (å‹ç¼©æ ¼å¼)
- **`raw_variants_vcf_index`**: åŸå§‹VCFç´¢å¼•æ–‡ä»¶
- **`filtered_variants_vcf`**: è¿‡æ»¤åå˜å¼‚VCFæ–‡ä»¶
- **`filtered_variants_vcf_index`**: è¿‡æ»¤VCFç´¢å¼•æ–‡ä»¶

### åˆ†ææŠ¥å‘Š
- **`variant_stats`**: è¿‡æ»¤åå˜å¼‚ç»Ÿè®¡
- **`raw_variant_stats`**: åŸå§‹å˜å¼‚ç»Ÿè®¡
- **`variant_report`**: ç»¼åˆåˆ†ææŠ¥å‘Š
- **`variant_density`**: å˜å¼‚å¯†åº¦åˆ†æ

## âš™ï¸ å‚æ•°é…ç½®

### å¿…éœ€å‚æ•°
- **`reference_genome`**: å‚è€ƒåŸºå› ç»„æ–‡ä»¶ (FASTAæ ¼å¼)
- **`input_bam`**: è¾“å…¥BAMæ–‡ä»¶ (å·²æ’åº)
- **`input_bam_index`**: BAMæ–‡ä»¶ç´¢å¼• (.baiæ–‡ä»¶)
- **`sample_name`**: æ ·æœ¬åç§°

### å¯é€‰å‚æ•°
- **`gatk_cpu`**: GATKä»»åŠ¡CPUæ ¸å¿ƒæ•° (é»˜è®¤: 16)
- **`gatk_memory_gb`**: GATKä»»åŠ¡å†…å­˜å¤§å° (é»˜è®¤: 32GB)
- **`bcftools_cpu`**: BCFtoolsä»»åŠ¡CPUæ ¸å¿ƒæ•° (é»˜è®¤: 8)
- **`bcftools_memory_gb`**: BCFtoolsä»»åŠ¡å†…å­˜å¤§å° (é»˜è®¤: 16GB)

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. **ä»»åŠ¡å¿«é€Ÿå¤±è´¥ (< 1åˆ†é’Ÿ)**
- **å¯èƒ½åŸå› **: åºåˆ—å­—å…¸è·¯å¾„é—®é¢˜æˆ–GATKå‚æ•°é”™è¯¯
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `variant_calling_from_bam_final_fixed.wdl`

#### 2. **"exec format error"**
- **å¯èƒ½åŸå› **: Dockeré•œåƒæ¶æ„ä¸å…¼å®¹
- **è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ä½¿ç”¨x86_64å…¼å®¹é•œåƒ

#### 3. **å†…å­˜ä¸è¶³é”™è¯¯**
- **å¯èƒ½åŸå› **: å†…å­˜é…ç½®è¿‡ä½
- **è§£å†³æ–¹æ¡ˆ**: å¢åŠ  `gatk_memory_gb` å‚æ•°å€¼

### æ—¥å¿—åˆ†æ
```bash
# è·å–è¿è¡Œæ—¥å¿—
aws omics get-run-logs --id <run-id>

# è·å–ä»»åŠ¡è¯¦ç»†æ—¥å¿—
aws omics get-task-logs --run-id <run-id> --task-id <task-id>
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æµ‹è¯•ç¯å¢ƒ
- **æ•°æ®**: å¥¶ç‰›åŸºå› ç»„ (ARS-UCD1.2, ~2.75GB)
- **è¾“å…¥**: ~8GB BAMæ–‡ä»¶
- **èµ„æº**: 16 CPU, 32GBå†…å­˜

### æ€§èƒ½æŒ‡æ ‡
- **GATKä»»åŠ¡**: 1-2å°æ—¶
- **BCFtoolsä»»åŠ¡**: 5-10åˆ†é’Ÿ
- **æ€»è¿è¡Œæ—¶é—´**: 1.5-2.5å°æ—¶
- **è¾“å‡ºå¤§å°**: ~100MB VCFæ–‡ä»¶

## ğŸ”„ ç‰ˆæœ¬å†å²

### v3.0 (æœ€æ–°) - 2025-08-10
- âœ… å®Œå…¨ä¿®å¤åºåˆ—å­—å…¸è·¯å¾„é—®é¢˜
- âœ… è§£å†³GATKå‚æ•°å…¼å®¹æ€§é—®é¢˜
- âœ… æ”¯æŒx86_64æ¶æ„Dockeré•œåƒ
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… å®Œæ•´æµ‹è¯•éªŒè¯

### v2.0 - 2025-08-10
- âœ… ä¿®å¤GATKå‚æ•°é”™è¯¯
- âœ… æ›´æ–°Dockeré•œåƒæ¶æ„
- âŒ åºåˆ—å­—å…¸è·¯å¾„é—®é¢˜æœªå®Œå…¨è§£å†³

### v1.0 - 2025-08-09
- âœ… åŸºç¡€å˜å¼‚æ£€æµ‹åŠŸèƒ½
- âŒ å­˜åœ¨å¤šä¸ªå…¼å®¹æ€§é—®é¢˜

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤è¾“å…¥æ–‡ä»¶æ ¼å¼å’Œè·¯å¾„æ­£ç¡®
3. éªŒè¯IAMæƒé™é…ç½®
4. å‚è€ƒæ•…éšœæ’é™¤éƒ¨åˆ†

---

**æœ€åæ›´æ–°**: 2025å¹´8æœˆ10æ—¥  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ªï¼Œç»è¿‡å®Œæ•´æµ‹è¯•éªŒè¯
