# 03_å˜å¼‚æ£€æµ‹ (Variant Detection)

## ğŸ“‹ ç›®å½•è¯´æ˜

æœ¬ç›®å½•åŒ…å«åŸºå› ç»„å˜å¼‚æ£€æµ‹ç›¸å…³çš„å·¥ä½œæµå’Œå·¥å…·ï¼Œè´Ÿè´£ä»æ¯”å¯¹ç»“æœä¸­è¯†åˆ«SNPã€InDelç­‰åŸºå› ç»„å˜å¼‚ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### å˜å¼‚è°ƒç”¨ (Variant Calling)
- **GATK HaplotypeCaller**: é«˜ç²¾åº¦å˜å¼‚æ£€æµ‹
- **BCFtools**: å¿«é€Ÿå˜å¼‚è°ƒç”¨
- **FreeBayes**: è´å¶æ–¯å˜å¼‚æ£€æµ‹
- **DeepVariant**: æ·±åº¦å­¦ä¹ å˜å¼‚æ£€æµ‹

### å˜å¼‚è¿‡æ»¤ (Variant Filtering)
- **ç¡¬è¿‡æ»¤**: åŸºäºè´¨é‡åˆ†æ•°çš„ä¸¥æ ¼è¿‡æ»¤
- **VQSR**: å˜å¼‚è´¨é‡åˆ†æ•°é‡æ ¡å‡†
- **æ·±åº¦è¿‡æ»¤**: åŸºäºè¦†ç›–æ·±åº¦çš„è¿‡æ»¤
- **ç­‰ä½åŸºå› é¢‘ç‡è¿‡æ»¤**: åŸºäºç¾¤ä½“é¢‘ç‡çš„è¿‡æ»¤

### è´¨é‡æ§åˆ¶ (Quality Control)
- å˜å¼‚è°ƒç”¨ç»Ÿè®¡
- Ti/Tvæ¯”ç‡åˆ†æ
- å˜å¼‚å¯†åº¦åˆ†å¸ƒ
- è´¨é‡æŒ‡æ ‡è¯„ä¼°

## ğŸ“ æ–‡ä»¶ç»“æ„

```
03_variant_detection/
â”œâ”€â”€ README.md                           # æœ¬è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ variant_calling_workflow.wdl       # å˜å¼‚æ£€æµ‹ä¸»å·¥ä½œæµ
â”œâ”€â”€ tasks/                              # ä»»åŠ¡å®šä¹‰ç›®å½•ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ gatk_haplotypecaller_task.wdl  # GATKå˜å¼‚è°ƒç”¨ä»»åŠ¡
â”‚   â”œâ”€â”€ bcftools_calling_task.wdl      # BCFtoolså˜å¼‚è°ƒç”¨ä»»åŠ¡
â”‚   â”œâ”€â”€ variant_filtering_task.wdl     # å˜å¼‚è¿‡æ»¤ä»»åŠ¡
â”‚   â”œâ”€â”€ variant_qc_task.wdl            # å˜å¼‚è´¨é‡æ§åˆ¶ä»»åŠ¡
â”‚   â””â”€â”€ vcf_processing_task.wdl        # VCFæ–‡ä»¶å¤„ç†ä»»åŠ¡
â”œâ”€â”€ inputs/                             # è¾“å…¥å‚æ•°é…ç½®ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ variant_calling_inputs.json    # å˜å¼‚æ£€æµ‹å‚æ•°é…ç½®
â”‚   â””â”€â”€ filtering_parameters.json      # è¿‡æ»¤å‚æ•°é…ç½®
â”œâ”€â”€ resources/                          # èµ„æºæ–‡ä»¶ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ known_sites.vcf                # å·²çŸ¥å˜å¼‚ä½ç‚¹
â”‚   â””â”€â”€ filtering_thresholds.txt       # è¿‡æ»¤é˜ˆå€¼é…ç½®
â””â”€â”€ scripts/                            # è¾…åŠ©è„šæœ¬ï¼ˆå¾…åˆ›å»ºï¼‰
    â”œâ”€â”€ variant_stats.py               # å˜å¼‚ç»Ÿè®¡åˆ†æ
    â””â”€â”€ vcf_validation.sh              # VCFæ–‡ä»¶éªŒè¯
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å˜å¼‚æ£€æµ‹æµç¨‹
```bash
# ä½¿ç”¨AWS Omicsè¿è¡Œå˜å¼‚æ£€æµ‹å·¥ä½œæµ
aws omics start-run \
    --workflow-id <workflow-id> \
    --parameters file://inputs/variant_calling_inputs.json \
    --name "cattle-variant-calling-$(date +%Y%m%d)"
```

### 2. è¾“å…¥æ•°æ®è¦æ±‚
- **BAMæ–‡ä»¶**: æ¥è‡ª02_sequence_alignmentæ­¥éª¤çš„æ¯”å¯¹ç»“æœ
- **å‚è€ƒåŸºå› ç»„**: ä¸æ¯”å¯¹ä½¿ç”¨çš„ç›¸åŒå‚è€ƒåŸºå› ç»„
- **å·²çŸ¥å˜å¼‚ä½ç‚¹**: ç”¨äºåŸºçº¿é‡æ ¡å‡†ï¼ˆå¯é€‰ï¼‰

### 3. å¤šæ ·æœ¬å˜å¼‚æ£€æµ‹
```bash
# è”åˆå˜å¼‚æ£€æµ‹ï¼ˆå¤šä¸ªæ ·æœ¬ï¼‰
aws omics start-run \
    --workflow-id <joint-calling-workflow-id> \
    --parameters file://inputs/joint_calling_inputs.json \
    --name "cattle-joint-calling-$(date +%Y%m%d)"
```

## âš™ï¸ å˜å¼‚æ£€æµ‹å‚æ•°

### GATK HaplotypeCallerå‚æ•°
- **æœ€å°åŸºç¡€è´¨é‡**: 20
- **æœ€å°æ¯”å¯¹è´¨é‡**: 20
- **æ ‡å‡†ç½®ä¿¡åº¦é˜ˆå€¼**: 10.0
- **å‘å°„ç½®ä¿¡åº¦é˜ˆå€¼**: 30.0

### å˜å¼‚è¿‡æ»¤æ ‡å‡†
- **è´¨é‡åˆ†æ•°**: QUAL > 30
- **è¦†ç›–æ·±åº¦**: DP > 10 && DP < 200
- **ç­‰ä½åŸºå› å¹³è¡¡**: AB > 0.2 && AB < 0.8
- **é“¾åå‘**: SOR < 3.0

### BCFtoolså‚æ•°
- **æœ€å°è¦†ç›–æ·±åº¦**: 10
- **æœ€å°å˜å¼‚è´¨é‡**: 20
- **æœ€å°ç­‰ä½åŸºå› é¢‘ç‡**: 0.1

## ğŸ“Š è¾“å‡ºç»“æœ

### ä¸»è¦è¾“å‡ºæ–‡ä»¶
- **raw_variants.vcf**: åŸå§‹å˜å¼‚è°ƒç”¨ç»“æœ
- **filtered_variants.vcf**: è¿‡æ»¤åçš„é«˜è´¨é‡å˜å¼‚
- **variant_stats.txt**: å˜å¼‚ç»Ÿè®¡ä¿¡æ¯
- **variant_report.html**: è¯¦ç»†çš„å˜å¼‚åˆ†ææŠ¥å‘Š

### å˜å¼‚ç±»å‹ç»Ÿè®¡
- **SNPæ•°é‡**: å•æ ¸è‹·é…¸å¤šæ€æ€§
- **InDelæ•°é‡**: æ’å…¥ç¼ºå¤±å˜å¼‚
- **Ti/Tvæ¯”ç‡**: è½¬æ¢/é¢ æ¢æ¯”ç‡
- **æ‚åˆ/çº¯åˆæ¯”ç‡**: åŸºå› å‹åˆ†å¸ƒ

## ğŸ” è´¨é‡æŒ‡æ ‡

### å˜å¼‚è°ƒç”¨è´¨é‡
- **Ti/Tvæ¯”ç‡**: 2.0-2.1 (å…¨åŸºå› ç»„)
- **InDel/SNPæ¯”ç‡**: ~0.1-0.15
- **æ‚åˆç‡**: 0.1-0.3% (å–å†³äºç‰©ç§)
- **æ–°å˜å¼‚æ¯”ä¾‹**: <5% (ä¸å·²çŸ¥æ•°æ®åº“æ¯”è¾ƒ)

### è¿‡æ»¤æ•ˆæœ
- **è¿‡æ»¤å‰å˜å¼‚æ•°**: æ€»å˜å¼‚æ•°é‡
- **è¿‡æ»¤åå˜å¼‚æ•°**: é«˜è´¨é‡å˜å¼‚æ•°é‡
- **è¿‡æ»¤ç‡**: é€šå¸¸20-40%
- **å‡é˜³æ€§ä¼°è®¡**: <5%

## ğŸ§¬ å˜å¼‚ç±»å‹åˆ†æ

### SNPåˆ†æ
- è½¬æ¢ (Aâ†”G, Câ†”T)
- é¢ æ¢ (A/Tâ†”C/G)
- åŒä¹‰/éåŒä¹‰å˜å¼‚
- å¯åŠ¨å­åŒºåŸŸå˜å¼‚

### InDelåˆ†æ
- æ’å…¥å˜å¼‚ (Insertions)
- ç¼ºå¤±å˜å¼‚ (Deletions)
- æ¡†å†…/æ¡†ç§»å˜å¼‚
- é‡å¤åºåˆ—åŒºåŸŸInDel

### ç»“æ„å˜å¼‚ (å¯é€‰)
- å¤§ç‰‡æ®µç¼ºå¤± (>50bp)
- é‡å¤åºåˆ—æ‰©å¢
- å€’ä½å’Œæ˜“ä½
- æ‹·è´æ•°å˜å¼‚ (CNV)

## ğŸ”§ å·¥ä½œæµç‰¹æ€§

### å¹¶è¡Œå¤„ç†
- æŸ“è‰²ä½“çº§åˆ«å¹¶è¡Œè°ƒç”¨
- åŒºé—´åˆ†å‰²å¹¶è¡Œå¤„ç†
- åˆ†å¸ƒå¼è®¡ç®—ä¼˜åŒ–

### è´¨é‡ä¿è¯
- å¤šé‡éªŒè¯æœºåˆ¶
- äº¤å‰éªŒè¯ä¸åŒç®—æ³•
- ç»Ÿè®¡å­¦è´¨é‡è¯„ä¼°

### å¯æ‰©å±•æ€§
- æ”¯æŒå•æ ·æœ¬å’Œå¤šæ ·æœ¬
- é€‚é…ä¸åŒæµ‹åºæ·±åº¦
- çµæ´»çš„è¿‡æ»¤ç­–ç•¥

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### è®¡ç®—èµ„æº
- **CPU**: 32-64æ ¸å¿ƒæ¨è
- **å†…å­˜**: 128GBæ¨è (å¤§åŸºå› ç»„)
- **å­˜å‚¨**: é«˜é€ŸSSDå­˜å‚¨

### ä¼˜åŒ–ç­–ç•¥
- æ™ºèƒ½åŒºé—´åˆ†å‰²
- å†…å­˜æ˜ å°„æ–‡ä»¶è®¿é—®
- å¹¶è¡ŒI/Oæ“ä½œ

## ğŸ”— æ•°æ®æµå‘

### è¾“å…¥æ¥æº
- **02_sequence_alignment**: BAMæ¯”å¯¹æ–‡ä»¶
- **genomic_data/02_reference_genome**: å‚è€ƒåŸºå› ç»„

### è¾“å‡ºå»å‘
- **04_variant_annotation**: VCFæ–‡ä»¶ç”¨äºåŠŸèƒ½æ³¨é‡Š
- **genomic_data/variants**: å­˜å‚¨å˜å¼‚æ£€æµ‹ç»“æœ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GATKæœ€ä½³å®è·µ](https://gatk.broadinstitute.org/hc/en-us/sections/360007226651)
- [BCFtoolsæ‰‹å†Œ](http://samtools.github.io/bcftools/bcftools.html)
- [VCFæ ¼å¼è§„èŒƒ](https://samtools.github.io/hts-specs/VCFv4.2.pdf)
- [å˜å¼‚æ£€æµ‹æœ€ä½³å®è·µ](../docs/variant_calling_best_practices.md)

---

**æ³¨æ„**: å˜å¼‚æ£€æµ‹çš„å‡†ç¡®æ€§ç›´æ¥å½±å“åç»­çš„åŠŸèƒ½åˆ†æï¼Œå»ºè®®ä½¿ç”¨å¤šç§ç®—æ³•è¿›è¡Œäº¤å‰éªŒè¯ã€‚
